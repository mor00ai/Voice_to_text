<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Voice to Text PWA</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#1976d2" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Voice to Text" />
  <style>
    /* ... (tutto il CSS invariato dal tuo file) ... */
  </style>
</head>
<body>
  <div class="container">
    <h1>🎤 Voice to Text</h1>
    <label for="language">🌐 Seleziona Lingua:</label>
    <select id="language">
      <option value="it-IT">🇮🇹 Italiano</option>
      <option value="en-US">🇺🇸 English (US)</option>
      <option value="en-GB">🇬🇧 English (UK)</option>
      <option value="es-ES">🇪🇸 Español (España)</option>
      <option value="es-MX">🇲🇽 Español (México)</option>
      <option value="fr-FR">🇫🇷 Français</option>
      <option value="de-DE">🇩🇪 Deutsch</option>
      <option value="pt-PT">🇵🇹 Português (Portugal)</option>
      <option value="pt-BR">🇧🇷 Português (Brasil)</option>
    </select>
    <div class="language-info" id="languageInfo">
      Lingua selezionata: Italiano - Ottimizzato per riconoscimento continuo
    </div>
    <button id="startBtn">🎙️ Avvia Registrazione</button>
    <button id="stopBtn" disabled>🛑 Ferma</button>
    <div class="recognition-status" id="recognitionStatus">Pronto per la registrazione</div>
    <textarea id="output" placeholder="Il testo apparirà qui..."></textarea>
    <div class="text-actions">
      <button id="sendWA">📱 Invia su WhatsApp</button>
      <button id="sendTG">📨 Invia su Telegram</button>
      <button id="sendMsg">✉️ Invia Messaggio</button>
      <button id="exportPDF">📄 Esporta PDF</button>
    </div>
    <div class="cache-control">
      <p>⚙️ Gestione cache e service worker:</p>
      <button id="clearCacheBtn">🗑️ Pulisci Cache & Disinstalla SW</button>
      <div class="status" id="cacheStatus"></div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // Versione dell'app per cache busting automatico
    const APP_VERSION = Date.now();
    // Configurazioni lingua (come nel tuo file)
    const LANGUAGE_CONFIGS = {
      'it-IT': { name: 'Italiano', flag: '🇮🇹', continuous: true, interimResults: true, maxAlternatives: 3, grammars: null, sensitivity: 'high', restartDelay: 100, silenceTimeout: 4000, maxSilence: 6000 },
      'en-US': { name: 'English (US)', flag: '🇺🇸', continuous: true, interimResults: true, maxAlternatives: 3, grammars: null, sensitivity: 'high', restartDelay: 150, silenceTimeout: 3500, maxSilence: 5500 },
      'en-GB': { name: 'English (UK)', flag: '🇬🇧', continuous: true, interimResults: true, maxAlternatives: 3, grammars: null, sensitivity: 'high', restartDelay: 150, silenceTimeout: 3500, maxSilence: 5500 },
      'es-ES': { name: 'Español (España)', flag: '🇪🇸', continuous: true, interimResults: true, maxAlternatives: 3, grammars: null, sensitivity: 'high', restartDelay: 100, silenceTimeout: 3000, maxSilence: 5000 },
      'es-MX': { name: 'Español (México)', flag: '🇲🇽', continuous: true, interimResults: true, maxAlternatives: 3, grammars: null, sensitivity: 'high', restartDelay: 100, silenceTimeout: 3000, maxSilence: 5000 },
      'fr-FR': { name: 'Français', flag: '🇫🇷', continuous: true, interimResults: true, maxAlternatives: 3, grammars: null, sensitivity: 'high', restartDelay: 200, silenceTimeout: 4000, maxSilence: 6000 },
      'de-DE': { name: 'Deutsch', flag: '🇩🇪', continuous: true, interimResults: true, maxAlternatives: 3, grammars: null, sensitivity: 'high', restartDelay: 200, silenceTimeout: 4500, maxSilence: 6500 },
      'pt-PT': { name: 'Português (Portugal)', flag: '🇵🇹', continuous: true, interimResults: true, maxAlternatives: 3, grammars: null, sensitivity: 'high', restartDelay: 150, silenceTimeout: 3500, maxSilence: 5500 },
      'pt-BR': { name: 'Português (Brasil)', flag: '🇧🇷', continuous: true, interimResults: true, maxAlternatives: 3, grammars: null, sensitivity: 'high', restartDelay: 150, silenceTimeout: 3500, maxSilence: 5500 }
    };

    // Service Worker (come nel tuo file)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register(`sw.js?v=${APP_VERSION}`)
        .then(reg => {
          setInterval(() => { reg.update(); }, 30000);
          reg.addEventListener('updatefound', () => {
            const newWorker = reg.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                if (confirm('Nuova versione disponibile! Ricaricare la pagina?')) {
                  window.location.reload();
                }
              }
            });
          });
        })
        .catch(err => console.error('Errore registrazione SW:', err));
    }

    // Elementi DOM
    const output = document.getElementById('output');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const languageSelect = document.getElementById('language');
    const recognitionStatus = document.getElementById('recognitionStatus');
    const languageInfo = document.getElementById('languageInfo');

    let recognition;
    let fullTranscript = '';
    let isListening = false;
    let shouldRestart = false;
    let restartTimeout;
    let silenceTimeout;
    let lastResultTime = Date.now();
    let currentConfig = LANGUAGE_CONFIGS['it-IT'];
    let consecutiveErrors = 0;
    let maxConsecutiveErrors = 3;

    // --- PATCH: Rileva WebView Android ---
    function isAndroidWebView() {
      return /(wv|\.0\.0\.0)/i.test(navigator.userAgent) ||
             (window.cordova !== undefined) ||
             (window.Capacitor !== undefined) ||
             (navigator.userAgent.includes('Version/') && navigator.userAgent.includes('Chrome/'));
    }
    // Variabile per evitare duplicati
    let lastFinalTranscript = '';

    function updateStatus(message, isError = false) {
      recognitionStatus.textContent = message;
      recognitionStatus.style.background = isError ? '#ffebee' : '#e3f2fd';
      recognitionStatus.style.color = isError ? '#d32f2f' : '#1976d2';
    }

    function updateLanguageInfo() {
      const selectedLang = languageSelect.value;
      const config = LANGUAGE_CONFIGS[selectedLang];
      if (config) {
        languageInfo.textContent = `${config.flag} ${config.name} - Ottimizzato per riconoscimento continuo`;
        currentConfig = config;
      }
    }

    function initRecognition() {
      if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
      } else if ('SpeechRecognition' in window) {
        recognition = new SpeechRecognition();
      } else {
        updateStatus('Riconoscimento vocale non supportato', true);
        startBtn.disabled = true;
        return;
      }
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.maxAlternatives = 3;

      recognition.onstart = () => {
        isListening = true;
        shouldRestart = true;
        lastResultTime = Date.now();
        consecutiveErrors = 0;
        startBtn.classList.add('recording');
        updateStatus(`🎙️ In ascolto ${currentConfig.flag} Parla ora!`);
        clearTimeout(silenceTimeout);
        silenceTimeout = setTimeout(checkForSilence, currentConfig.silenceTimeout);
      };

      recognition.onresult = (event) => {
        lastResultTime = Date.now();
        consecutiveErrors = 0;
        let interimTranscript = '';
        let finalTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          const result = event.results[i];
          let bestTranscript = result[0].transcript.trim();
          let bestConfidence = result[0].confidence || 0;
          for (let j = 1; j < Math.min(result.length, currentConfig.maxAlternatives); j++) {
            const altConfidence = result[j].confidence || 0;
            if (altConfidence > bestConfidence) {
              bestTranscript = result[j].transcript.trim();
              bestConfidence = altConfidence;
            }
          }
          if (result.isFinal) {
            finalTranscript += bestTranscript;
          } else {
            interimTranscript += bestTranscript;
          }
        }

        // --- PATCH: anti-duplicazione solo su Android WebView ---
        if (finalTranscript) {
          if (isAndroidWebView()) {
            if (finalTranscript === lastFinalTranscript) {
              // Salta il duplicato
              return;
            }
            lastFinalTranscript = finalTranscript;
          }
          if (fullTranscript && !fullTranscript.endsWith(' ') &&
              !fullTranscript.match(/[.!?]$/) &&
              !finalTranscript.match(/^[.!?,;:]/) &&
              !finalTranscript.match(/^[A-Z]/)) {
            fullTranscript += ' ';
          }
          fullTranscript += finalTranscript;
          if (fullTranscript.length > 0) {
            fullTranscript = fullTranscript.charAt(0).toUpperCase() + fullTranscript.slice(1);
          }
        }
        const displayText = fullTranscript + (interimTranscript ? (fullTranscript && !fullTranscript.endsWith(' ') ? ' ' : '') + interimTranscript : '');
        output.value = displayText;
        if (interimTranscript) {
          const truncated = interimTranscript.substring(0, 25) + (interimTranscript.length > 25 ? '...' : '');
          updateStatus(`🎤 ${currentConfig.flag} Elaborando... "${truncated}"`);
        } else if (finalTranscript) {
          updateStatus(`✅ ${currentConfig.flag} Frase acquisita`);
        }
        clearTimeout(silenceTimeout);
        silenceTimeout = setTimeout(checkForSilence, currentConfig.silenceTimeout);
      };

      recognition.onerror = (event) => {
        consecutiveErrors++;
        updateStatus('Errore riconoscimento: ' + event.error, true);
        if (consecutiveErrors >= maxConsecutiveErrors) {
          stopRecognition();
        } else {
          restartRecognition();
        }
      };

      recognition.onend = () => {
        isListening = false;
        startBtn.classList.remove('recording');
        if (shouldRestart && consecutiveErrors < maxConsecutiveErrors) {
          restartRecognition();
        } else {
          updateStatus('Registrazione terminata');
        }
      };
    }

    function startRecognition() {
      if (!recognition) initRecognition();
      recognition.lang = languageSelect.value;
      recognition.continuous = currentConfig.continuous;
      recognition.interimResults = currentConfig.interimResults;
      recognition.maxAlternatives = currentConfig.maxAlternatives;
      fullTranscript = '';
      lastFinalTranscript = '';
      output.value = '';
      recognition.start();
      startBtn.disabled = true;
      stopBtn.disabled = false;
    }

    function stopRecognition() {
      shouldRestart = false;
      if (recognition && isListening) {
        recognition.stop();
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }

    function restartRecognition() {
      stopRecognition();
      setTimeout(() => {
        if (shouldRestart) startRecognition();
      }, currentConfig.restartDelay);
    }

    function checkForSilence() {
      if (isListening && Date.now() - lastResultTime > currentConfig.maxSilence) {
        stopRecognition();
        updateStatus('Registrazione terminata per silenzio prolungato');
      }
    }

    // Event listeners
    startBtn.addEventListener('click', startRecognition);
    stopBtn.addEventListener('click', stopRecognition);
    languageSelect.addEventListener('change', updateLanguageInfo);

    // ... (resto delle funzioni: invio WhatsApp, Telegram, PDF, gestione cache, ecc. invariato) ...
  </script>
</body>
</html>

